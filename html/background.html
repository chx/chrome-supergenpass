<!--
ChromeGenPass = Google Chrome + SuperGenPass love.
Copyright (C) 2010 Denis Sokolov http://sokolov.cc

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<!DOCTYPE html>
<html><head>
<script>
	/*
		I had certain difficulty with optimizing jQuery load on pages
		without password fields.

		Also, for hell knows why, <script src="foo.js"> did not work on
		this background page, so I used an eval hack.
	*/
	function get(src, callback){
		var xhr = new XMLHttpRequest();
		xhr.onreadystatechange = function() {if (xhr.readyState == 3){
			callback(xhr.responseText);
		}};
		xhr.open('GET', chrome.extension.getURL(src), true);
		xhr.send();
	}

	passwords = [];
	supergenpass = null;

	get('js/jquery-1.4.2.min.js', function(res){ jQuery = res; });
	get('js/orig.js', function(res){ eval(res); });
	get('js/saveload.js', function(res){ eval(res); passwords = load(); });

	chrome.extension.onRequest.addListener(function(req, sender, sendResponse){
		var responded = false;
		
		if ('passwords' in req)
		{ // Options have been updated, new passwords available
			// Update local passwords
			passwords = req['passwords'];
			
			// Inform all tabs
			chrome.windows.getAll({ 'populate': true }, function(windows){
				for (i in windows){ for (j in windows[i].tabs){
					chrome.tabs.sendRequest(windows[i].tabs[j].id, {
						'passwords': passwords,
					})
				}}
			});
		}

		if ('init' in req)
		{ // A new tab wants to work with us, let's give it info
			sendResponse({
				'passwords': passwords,
				'jquery': jQuery,
			});
			responded = true;
		}
		
		if ('password' in req)
		{
			var index = req['password'];
			if (!('password' in passwords[index]))
			{
				var stop = false;
				var second_attempt = false;
				while (!stop)
				{
					var entered = prompt_password(passwords[index], second_attempt);
					if (entered == null)
					{ // Cancelled
						console.log('stopping');
						stop = true;
					}
					else if (hash(entered) == passwords[index]['hash'])
					{ // Correct
						stop = true;
						passwords[index]['password'] = entered;
					}
					else
					{ // Wrong password
						second_attempt = true;
					}
				}
			}
			sendResponse({
				'passwords': passwords
			});
			responded = true;
		}

		// Close connection
		if (!responded)
			sendResponse({});
	});

	// Careful, the same settings are written in options/options.js
	// Change both. Will break all existing user settings!
	var hash = function(text){
		return supergenpass(text, 'chromegenpass-chrome-extension', 16);
	}

	function prompt_password(password, second_attempt)
	{
		var txt = '';
		if (second_attempt)
		{
			txt += 'Password "' + password['note'] + '" is incorrect. Perhaps you have made a mistake?\n\n';
			txt += 'Try again:';
		}
		else
		{
			txt += 'Security advice: ';
			txt += 'Always make sure that the title of this popup is "ChromeGenPass" and not "The page at ... says".\n\n';
			txt += 'Password "' + password['note'] + '" is locked.\n';
			txt += 'Please unlock it by entering it in the field below:';
		}
		return prompt(txt)
	}
	/*
		Reference for future use.
		chrome.pageAction.show(sender.tab.id);

		chrome.pageAction.onClicked.addListener(function(tab){
			chrome.tabs.sendRequest(tab.id, 'run');
		});
	*/
</script></head></html>